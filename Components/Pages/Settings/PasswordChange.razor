@page "/settings/password"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using KinmuReport.Models
@attribute [Authorize]
@inject AttendanceContext DbContext

<h3><i class="bi bi-key me-2"></i>パスワード変更</h3>

@if (!string.IsNullOrEmpty(message))
{
    var alertClass = isError ? "alert-danger" : "alert-success";
    <div class="alert @alertClass alert-dismissible fade show" role="alert">
        @message
        <button type="button" class="btn-close" @onclick="() => message = null"></button>
    </div>
}

<AuthorizeView Roles="管理者">
    <Authorized>
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-shield-lock me-1"></i>パスワードリセット（管理者機能）
            </div>
            <div class="card-body">
                <p class="text-muted small mb-3">
                    他のユーザーのパスワードをリセットできます。現在のパスワードは不要です。
                </p>
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label">対象ユーザー</label>
                        <select class="form-select" @bind="resetTargetId">
                            <option value="">-- 選択してください --</option>
                            @if (allUsers != null)
                            {
                                @foreach (var u in allUsers.Where(x => x.社員番号 != currentUserId))
                                {
                                    <option value="@u.社員番号">@u.社員名 (@u.社員番号)</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">新しいパスワード</label>
                        <input type="password" class="form-control" @bind="resetNewPassword"
                               placeholder="8文字以上" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">確認</label>
                        <input type="password" class="form-control" @bind="resetConfirmPassword"
                               placeholder="もう一度入力" />
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-warning" @onclick="HandleReset"
                                disabled="@(!CanReset)">
                            <i class="bi bi-arrow-counterclockwise me-1"></i>リセット
                        </button>
                    </div>
                </div>
                @if (!string.IsNullOrEmpty(resetNewPassword) && resetNewPassword.Length < 8)
                {
                    <div class="text-danger small mt-2">パスワードは8文字以上で入力してください</div>
                }
                @if (!string.IsNullOrEmpty(resetNewPassword) && !string.IsNullOrEmpty(resetConfirmPassword)
                     && resetNewPassword != resetConfirmPassword)
                {
                    <div class="text-danger small mt-2">パスワードが一致しません</div>
                }
            </div>
        </div>
    </Authorized>
</AuthorizeView>

<div class="card">
    <div class="card-header">
        <i class="bi bi-person-lock me-1"></i>@(hasPassword ? "自分のパスワードを変更" : "パスワードを設定")
    </div>
    <div class="card-body">
        @if (!hasPassword)
        {
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-1"></i>パスワードが未設定です。新しいパスワードを設定してください。
            </div>
        }
        <div class="row g-3">
            @if (hasPassword)
            {
                <div class="col-md-4">
                    <label class="form-label">現在のパスワード</label>
                    <input type="password" class="form-control" @bind="currentPassword" />
                </div>
            }
            <div class="col-md-4">
                <label class="form-label">新しいパスワード</label>
                <input type="password" class="form-control" @bind="newPassword"
                       placeholder="8文字以上" />
            </div>
            <div class="col-md-4">
                <label class="form-label">新しいパスワード（確認）</label>
                <input type="password" class="form-control" @bind="confirmPassword"
                       placeholder="もう一度入力" />
            </div>
        </div>
        @if (!string.IsNullOrEmpty(newPassword) && newPassword.Length < 8)
        {
            <div class="text-danger small mt-2">パスワードは8文字以上で入力してください</div>
        }
        @if (!string.IsNullOrEmpty(newPassword) && !string.IsNullOrEmpty(confirmPassword)
             && newPassword != confirmPassword)
        {
            <div class="text-danger small mt-2">パスワードが一致しません</div>
        }
        <div class="mt-3">
            <button class="btn btn-primary" @onclick="HandleChangePassword"
                    disabled="@(!CanChangePassword)">
                <i class="bi bi-check-lg me-1"></i>変更する
            </button>
        </div>
    </div>
</div>

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthState { get; set; }

    private string? currentUserId;
    private string? currentRole;
    private bool hasPassword = true;
    private List<社員>? allUsers;

    // 自分のパスワード変更
    private string currentPassword = "";
    private string newPassword = "";
    private string confirmPassword = "";

    // 管理者によるリセット
    private string resetTargetId = "";
    private string resetNewPassword = "";
    private string resetConfirmPassword = "";

    private string? message;
    private bool isError;

    private bool CanChangePassword =>
        (hasPassword ? !string.IsNullOrEmpty(currentPassword) : true) &&
        !string.IsNullOrEmpty(newPassword) &&
        newPassword.Length >= 8 &&
        newPassword == confirmPassword;

    private bool CanReset =>
        !string.IsNullOrEmpty(resetTargetId) &&
        !string.IsNullOrEmpty(resetNewPassword) &&
        resetNewPassword.Length >= 8 &&
        resetNewPassword == resetConfirmPassword;

    protected override async Task OnInitializedAsync()
    {
        if (AuthState != null)
        {
            var authState = await AuthState;
            currentUserId = authState.User.FindFirst(ClaimNames.EmployeeId)?.Value;
            currentRole = authState.User.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value;

            // パスワード登録済みかチェック
            if (!string.IsNullOrEmpty(currentUserId))
            {
                var user = await DbContext.社員s.FindAsync(currentUserId);
                hasPassword = !string.IsNullOrEmpty(user?.パスワードハッシュ);
            }

            if (currentRole == Roles.Admin)
            {
                allUsers = await DbContext.社員s
                    .OrderBy(u => u.社員番号)
                    .ToListAsync();
            }
        }
    }

    private async Task HandleChangePassword()
    {
        if (string.IsNullOrEmpty(currentUserId)) return;

        try
        {
            var user = await DbContext.社員s.FindAsync(currentUserId);
            if (user == null)
            {
                message = "ユーザーが見つかりません。";
                isError = true;
                return;
            }

            // 現在のパスワードを検証（パスワード登録済みの場合のみ）
            if (hasPassword)
            {
                if (!BCrypt.Net.BCrypt.Verify(currentPassword, user.パスワードハッシュ))
                {
                    message = "現在のパスワードが正しくありません。";
                    isError = true;
                    return;
                }
            }

            // 新しいパスワードをハッシュ化して保存
            user.パスワードハッシュ = BCrypt.Net.BCrypt.HashPassword(newPassword);
            await DbContext.SaveChangesAsync();

            message = hasPassword ? "パスワードを変更しました。" : "パスワードを設定しました。";
            isError = false;
            hasPassword = true;

            // フィールドをクリア
            currentPassword = "";
            newPassword = "";
            confirmPassword = "";
        }
        catch (Exception ex)
        {
            message = $"エラーが発生しました: {ex.Message}";
            isError = true;
        }
    }

    private async Task HandleReset()
    {
        if (string.IsNullOrEmpty(resetTargetId)) return;

        try
        {
            var user = await DbContext.社員s.FindAsync(resetTargetId);
            if (user == null)
            {
                message = "対象ユーザーが見つかりません。";
                isError = true;
                return;
            }

            // 新しいパスワードをハッシュ化して保存
            user.パスワードハッシュ = BCrypt.Net.BCrypt.HashPassword(resetNewPassword);
            await DbContext.SaveChangesAsync();

            message = $"{user.社員名} のパスワードをリセットしました。";
            isError = false;

            // フィールドをクリア
            resetTargetId = "";
            resetNewPassword = "";
            resetConfirmPassword = "";
        }
        catch (Exception ex)
        {
            message = $"エラーが発生しました: {ex.Message}";
            isError = true;
        }
    }
}
