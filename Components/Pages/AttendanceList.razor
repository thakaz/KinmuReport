@page "/attendance"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@inject KinmuReport.Models.AttendanceContext DbContext
@inject NavigationManager Navigation
@inject KinmuReport.Services.LockService LockService


<PageTitle>提出状況一覧</PageTitle>

<h2 class="mb-4">
    <i class="bi bi-table me-2"></i>提出状況一覧
</h2>

@* ── 検索条件 ── *@
<div class="card mb-3">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-auto">
                <label class="form-label">対象年月</label>
                <input type="number" class="form-control" @bind="selectedYearMonth"
                       placeholder="202509" style="width: 120px" />
            </div>
            <div class="col-auto">
                <button class="btn btn-primary" @onclick="Search">
                    <i class="bi bi-search me-1"></i>検索
                </button>
            </div>
        </div>
    </div>
</div>

@* ── 結果テーブル ── *@
@if (summaries != null)
{
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-sm mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>社員番号</th>
                            <th>社員名</th>
                            <th>状態</th>
                            <th class="text-end">所定内計</th>
                            <th class="text-end">残業計</th>
                            <th class="text-end">深夜計</th>
                            <th class="text-end">合計</th>
                            <th>提出日時</th>
                            <th class="text-end">版数</th>
                            <th>ロック</th>

                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var s in summaries)
                        {
                            <tr style="cursor: pointer" @onclick="() => GoToDetail(s.社員番号)">
                                <td>@s.社員番号</td>
                                <td>@s.社員名</td>
                                <td>
                                    @if (s.提出済み)
                                    {
                                        <span class="badge bg-success">提出済</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">未提出</span>
                                    }
                                </td>
                                <td class="text-end">@s.所定内計?.ToString("0.00")</td>
                                <td class="text-end">@s.残業計?.ToString("0.00")</td>
                                <td class="text-end">@s.深夜計?.ToString("0.00")</td>
                                <td class="text-end">@s.合計?.ToString("0.00")</td>
                                <td>@s.提出日時?.ToString("yyyy/MM/dd HH:mm")</td>
                                <td class="text-end">@s.版数</td>
                                <td>@if (s.ロック者名 != null)
                                    {
                                        <span class="badge bg-warning text-dark"> <i class="bi bi-lock-fill me-1"></i>@s.ロック者名</span>    
                                        <AuthorizeView Roles="管理者">
                                            <button class="btn btn-outline-danger btn-sm" 
                                            @onclick="()=>ForceRelease(s.社員番号)" @onclick:stopPropagation="true">解除</button>
                                        </AuthorizeView>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer text-muted">
            @summaries.Count 件
        </div>
    </div>
}

@code {
    [CascadingParameter] Task<AuthenticationState> AuthState { get; set; } = default!;

    int selectedYearMonth = DateTime.Now.Year * 100 + DateTime.Now.Month;

    List<EmployeeSummary> summaries = new();

    string currentUserId = "";
    string currentRole = "";
    string currentGroup = "";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthState;
        var user = authState.User;
        currentUserId = user.FindFirst("社員番号")?.Value ?? "";
        currentRole = user.FindFirst(ClaimTypes.Role)?.Value ?? "";
        currentGroup = user.FindFirst("グループコード")?.Value ?? "";

        await Search();
    }

    async Task Search()
    {
        // 権限に応じた社員リスト取得
        var employeeQuery = DbContext.社員s.AsQueryable();
        switch (currentRole)
        {
            case "管理者":
                break;
            case "グループ管理者":
                employeeQuery = employeeQuery.Where(e => e.グループコード == currentGroup);
                break;
            default:
                employeeQuery = employeeQuery.Where(e => e.社員番号 == currentUserId);
                break;
        }
        var employees = await employeeQuery.OrderBy(e => e.社員番号).ToListAsync();

        // 対象年月の勤怠を集約
        var empIds = employees.Select(e => e.社員番号).ToList();
        var 対象年月 = selectedYearMonth;

        var attendances = await DbContext.勤怠s
            .Where(k => empIds.Contains(k.社員番号)
                && k.対象年月 == 対象年月)
            .GroupBy(k => k.社員番号)
            .Select(g => new
            {
                社員番号 = g.Key,
                所定内計 = g.Sum(k => k.所定内時間),
                残業計 = g.Sum(k => k.残業時間),
                深夜計 = g.Sum(k => k.深夜残業時間),
                合計 = g.Sum(k => k.合計時間)
            })
            .ToListAsync();

        var uploads = await DbContext.アップロード履歴s
            .Where(u => empIds.Contains(u.社員番号) && u.対象年月 == 対象年月)
            .ToListAsync();

        var locks = await DbContext.ロックs
            .Include(l => l.ロック者番号Navigation)
            .Where(l => empIds.Contains(l.社員番号) && l.対象年月 == 対象年月)
            .ToListAsync();

        summaries = employees.Select(emp =>
        {
            var att = attendances.FirstOrDefault(a => a.社員番号 == emp.社員番号);
            var upl = uploads.FirstOrDefault(u => u.社員番号 == emp.社員番号);

            var lck = locks.FirstOrDefault(l => l.社員番号 == emp.社員番号);
            // タイムアウトチェック
            var isLocked = lck != null && (DateTime.Now - lck.ロック日時) <= TimeSpan.FromDays(1);

            return new EmployeeSummary
            {
                社員番号 = emp.社員番号,
                社員名 = emp.社員名,
                提出済み = upl != null,
                所定内計 = att?.所定内計,
                残業計 = att?.残業計,
                深夜計 = att?.深夜計,
                合計 = att?.合計,
                提出日時 = upl?.アップロード日時,
                版数 = upl?.sp版数,
                ロック者名 = isLocked ? lck!.ロック者番号Navigation?.社員名 : null
            };
        }).ToList();
    }

    async Task ForceRelease(string 社員番号)
    {
        await LockService.Release(社員番号, selectedYearMonth, currentUserId, currentRole);
        await Search();
    }

    void GoToDetail(string 社員番号)
    {
        Navigation.NavigateTo($"/attendance/{社員番号}/{selectedYearMonth}");
    }

    class EmployeeSummary
    {
        public string 社員番号 { get; set; } = "";
        public string 社員名 { get; set; } = "";
        public bool 提出済み { get; set; }
        public decimal? 所定内計 { get; set; }
        public decimal? 残業計 { get; set; }
        public decimal? 深夜計 { get; set; }
        public decimal? 合計 { get; set; }
        public DateTime? 提出日時 { get; set; }
        public int? 版数 { get; set; }
        public string ロック者名 { get; set; } = "";
    }
}
