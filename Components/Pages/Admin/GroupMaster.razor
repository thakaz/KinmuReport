@page "/admin/groups"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using KinmuReport.Models
@attribute [Authorize(Roles = "管理者")]
@inject AttendanceContext DbContext

<h3><i class="bi bi-diagram-3 me-2"></i>グループ管理</h3>

@if (!string.IsNullOrEmpty(message))
{
    var alertClass = isError ? "alert-danger" : "alert-success";
    <div class="alert @alertClass alert-dismissible fade show" role="alert">
        @message
        <button type="button" class="btn-close" @onclick="() => message = null"></button>
    </div>
}

<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-plus-circle me-1"></i>
        @(isEditing ? "グループ編集" : "新規グループ追加")
    </div>
    <div class="card-body">
        <EditForm Model="editModel" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">グループコード</label>
                    <InputText class="form-control" @bind-Value="editModel.グループコード"
                               disabled="@isEditing" placeholder="G001" />
                    <ValidationMessage For="() => editModel.グループコード" />
                </div>
                <div class="col-md-5">
                    <label class="form-label">グループ名</label>
                    <InputText class="form-control" @bind-Value="editModel.グループ名"
                               placeholder="開発グループ" />
                    <ValidationMessage For="() => editModel.グループ名" />
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="bi bi-check-lg me-1"></i>@(isEditing ? "更新" : "追加")
                    </button>
                    @if (isEditing)
                    {
                        <button type="button" class="btn btn-outline-secondary" @onclick="CancelEdit">
                            キャンセル
                        </button>
                    }
                </div>
            </div>
        </EditForm>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <i class="bi bi-list-ul me-1"></i>グループ一覧
    </div>
    <div class="card-body p-0">
        <table class="table table-striped table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>グループコード</th>
                    <th>グループ名</th>
                    <th>所属人数</th>
                    <th style="width: 100px;"></th>
                </tr>
            </thead>
            <tbody>
                @if (groups == null)
                {
                    <tr>
                        <td colspan="4" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">読み込み中...</span>
                            </div>
                        </td>
                    </tr>
                }
                else if (!groups.Any())
                {
                    <tr>
                        <td colspan="4" class="text-center text-muted py-4">グループがありません</td>
                    </tr>
                }
                else
                {
                    @foreach (var g in groups)
                    {
                        <tr>
                            <td>@g.グループコード</td>
                            <td>@g.グループ名</td>
                            <td>@g.MemberCount 名</td>
                            <td>
                                <button class="btn btn-outline-primary btn-sm" @onclick="() => StartEdit(g)">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    private List<GroupViewModel>? groups;
    private グループ editModel = new();
    private bool isEditing = false;
    private string? message;
    private bool isError;

    protected override async Task OnInitializedAsync()
    {
        await LoadGroups();
    }

    private async Task LoadGroups()
    {
        groups = await DbContext.グループs
            .Select(g => new GroupViewModel
            {
                グループコード = g.グループコード,
                グループ名 = g.グループ名,
                MemberCount = g.社員s.Count
            })
            .OrderBy(g => g.グループコード)
            .ToListAsync();
    }

    private async Task HandleSubmit()
    {
        try
        {
            if (isEditing)
            {
                var existing = await DbContext.グループs.FindAsync(editModel.グループコード);
                if (existing != null)
                {
                    existing.グループ名 = editModel.グループ名;
                    await DbContext.SaveChangesAsync();
                    message = "グループを更新しました。";
                    isError = false;
                }
            }
            else
            {
                if (await DbContext.グループs.AnyAsync(g => g.グループコード == editModel.グループコード))
                {
                    message = "このグループコードは既に使用されています。";
                    isError = true;
                    return;
                }

                DbContext.グループs.Add(new グループ
                {
                    グループコード = editModel.グループコード,
                    グループ名 = editModel.グループ名
                });
                await DbContext.SaveChangesAsync();
                message = "グループを追加しました。";
                isError = false;
            }

            editModel = new();
            isEditing = false;
            await LoadGroups();
        }
        catch (Exception ex)
        {
            message = $"エラーが発生しました: {ex.Message}";
            isError = true;
        }
    }

    private void StartEdit(GroupViewModel g)
    {
        editModel = new グループ
        {
            グループコード = g.グループコード,
            グループ名 = g.グループ名
        };
        isEditing = true;
        message = null;
    }

    private void CancelEdit()
    {
        editModel = new();
        isEditing = false;
        message = null;
    }

    private class GroupViewModel
    {
        public string グループコード { get; set; } = "";
        public string グループ名 { get; set; } = "";
        public int MemberCount { get; set; }
    }
}
